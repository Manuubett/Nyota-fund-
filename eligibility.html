<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business Capital Estimator ‚Äì Nyota Fund Guide</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0b7a43;
    --primary-dark: #095c33;
    --secondary: #4caf50;
    --accent: #ff9800;
    --danger: #f44336;
    --light: #f8f9fa;
    --dark: #333;
    --gray: #666;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f0f9f4 0%, #e6f4ec 100%);
    color: var(--dark);
    min-height: 100vh;
  }

  header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 20px 16px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(11, 122, 67, 0.25);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
  }

  .header-subtitle {
    margin-top: 6px;
    font-size: 14px;
    opacity: 0.9;
    font-weight: 400;
  }

  .container {
    padding: 20px 16px;
    max-width: 800px;
    margin: 0 auto;
  }

  .card {
    background: white;
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 20px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(11, 122, 67, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
  }

  .form-group {
    margin-bottom: 22px;
  }

  label {
    display: block;
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--primary-dark);
  }

  label i {
    margin-right: 8px;
    color: var(--primary);
  }

  input, select, textarea {
    width: 100%;
    padding: 14px 16px;
    font-size: 15px;
    border-radius: 10px;
    border: 2px solid #e0e0e0;
    background: #fafafa;
    transition: all 0.3s;
    font-family: inherit;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 3px rgba(11, 122, 67, 0.1);
  }

  .range-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 10px;
  }

  .range-value {
    background: var(--primary);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: bold;
    min-width: 80px;
    text-align: center;
  }

  input[type="range"] {
    flex: 1;
    height: 8px;
    -webkit-appearance: none;
    background: #e0e0e0;
    border-radius: 10px;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }

  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .checkbox-label:hover {
    background: #e9ecef;
  }

  .checkbox-label input {
    width: auto;
    margin-right: 10px;
  }

  .calculator-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-size: 14px;
  }

  .calculator-info i {
    color: #2196f3;
    margin-right: 8px;
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 16px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(to right, var(--primary), var(--secondary));
    color: white;
    box-shadow: 0 4px 12px rgba(11, 122, 67, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(11, 122, 67, 0.4);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }

  .btn-secondary:hover {
    background: #f0f9f4;
  }

  .btn-rewarded {
    background: linear-gradient(to right, #ff9800, #ffb74d);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
  }

  .btn-rewarded:hover {
    background: linear-gradient(to right, #f57c00, #ff9800);
  }

  .btn-rewarded i {
    animation: pulse 2s infinite;
  }

  .btn-disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
    opacity: 0.7;
  }

  .btn-disabled:hover {
    transform: none;
    box-shadow: none;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .result-container {
    display: none;
    animation: fadeIn 0.8s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-card {
    background: linear-gradient(135deg, #e6f4ec 0%, #d4edda 100%);
    border-left: 5px solid var(--primary);
    padding: 24px;
    border-radius: 12px;
    margin-top: 20px;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .result-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary-dark);
  }

  .result-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--primary);
    text-align: center;
    margin: 15px 0;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  }

  .result-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }

  .result-item {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  }

  .result-label {
    font-size: 13px;
    color: var(--gray);
    margin-bottom: 5px;
  }

  .result-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--dark);
  }

  .recommendations {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    border-left: 4px solid var(--accent);
  }

  .recommendations h4 {
    margin-top: 0;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .recommendations ul {
    margin: 10px 0 0 0;
    padding-left: 20px;
  }

  .recommendations li {
    margin-bottom: 8px;
    line-height: 1.5;
  }

  .sharing-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
  }

  .share-btn {
    padding: 10px 20px;
    border-radius: 8px;
    background: white;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .share-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .share-whatsapp {
    color: #25D366;
    border-color: #25D366;
  }

  .share-print {
    color: var(--primary);
    border-color: var(--primary);
  }

  .share-btn-locked {
    opacity: 0.6;
    position: relative;
    cursor: not-allowed;
  }

  .share-btn-locked:hover {
    transform: none;
    box-shadow: none;
  }

  .lock-icon {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }

  .ad-box {
    margin: 30px 0;
    padding: 20px;
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    text-align: center;
    border-radius: 12px;
    font-size: 14px;
    color: #495057;
    border: 1px solid #ced4da;
    font-weight: 500;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }

  .ad-box#nativeAdCalculator {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 1px solid #90caf9;
    color: #1565c0;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
  }

  .ad-note {
    font-size: 12px;
    color: #888;
    text-align: center;
    margin-top: 5px;
  }

  .history-item {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
  }

  .history-amount {
    font-weight: bold;
    color: var(--primary);
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    animation: modalFadeIn 0.3s;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal h3 {
    color: var(--primary);
    margin-top: 0;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .locked-feature {
    display: inline-block;
    background: rgba(255, 152, 0, 0.1);
    color: var(--accent);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    margin-left: 10px;
    border: 1px solid rgba(255, 152, 0, 0.3);
  }

  footer {
    text-align: center;
    padding: 20px;
    color: var(--gray);
    font-size: 13px;
    border-top: 1px solid #eee;
    margin-top: 20px;
  }

  @media (max-width: 768px) {
    .container {
      padding: 15px;
    }
    
    .card {
      padding: 18px;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .result-details {
      grid-template-columns: 1fr;
    }
    
    .checkbox-group {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<header>
  <h2><i class="fas fa-calculator"></i> Business Capital Estimator</h2>
  <div class="header-subtitle">Plan your Nyota Fund application with smart calculations</div>
</header>

<div class="container">

  <div class="calculator-info">
    <i class="fas fa-info-circle"></i>
    This tool helps estimate suitable capital for your business and provides insights for your Nyota Fund application. All calculations are for guidance only.
  </div>

  <div class="card">
    <div class="form-group">
      <label><i class="fas fa-store"></i> Business Type</label>
      <select id="businessType">
        <option value="retail">Retail Shop</option>
        <option value="agribusiness">Agribusiness</option>
        <option value="service">Service Business</option>
        <option value="manufacturing">Small Manufacturing</option>
        <option value="food">Food & Catering</option>
        <option value="tech">Technology/ICT</option>
        <option value="fashion">Fashion & Design</option>
        <option value="transport">Transport Services</option>
        <option value="other">Other Business</option>
      </select>
    </div>

    <div class="form-group">
      <label><i class="fas fa-map-marker-alt"></i> Business Location</label>
      <select id="businessLocation">
        <option value="urban">Urban Area (City/Town)</option>
        <option value="periurban">Peri-Urban Area</option>
        <option value="rural">Rural Area</option>
      </select>
    </div>

    <div class="form-group">
      <label><i class="fas fa-money-bill-wave"></i> Capital Required (KES)</label>
      <div class="range-container">
        <input type="range" id="amountRange" min="10000" max="1000000" step="10000" value="150000">
        <div class="range-value" id="amountValue">150,000</div>
      </div>
      <input type="number" id="amountInput" placeholder="Or enter specific amount" min="10000" max="2000000">
    </div>

    <div class="form-group">
      <label><i class="fas fa-users"></i> Business Stage</label>
      <select id="businessStage">
        <option value="idea">Business Idea (Not started)</option>
        <option value="startup">Startup (0-6 months)</option>
        <option value="growth">Growth Stage (6+ months)</option>
        <option value="expansion">Expansion Stage</option>
      </select>
    </div>

    <div class="form-group">
      <label><i class="fas fa-tasks"></i> Capital Allocation (Check all that apply)</label>
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="equipment"> Equipment/Machinery
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="inventory"> Inventory/Stock
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="rent"> Rent/Utilities
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="marketing"> Marketing
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="working"> Working Capital
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="allocation" value="training"> Training/Skills
        </label>
      </div>
    </div>

    <div class="form-group">
      <label><i class="fas fa-bullseye"></i> Expected Monthly Revenue (KES)</label>
      <input type="number" id="expectedRevenue" placeholder="Estimated monthly income">
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="saveForLater()">
        <i class="far fa-save"></i> Save
      </button>
      <button class="btn btn-primary" onclick="quickEstimate()">
        <i class="fas fa-bolt"></i> Quick Estimate
      </button>
      <button class="btn btn-rewarded" onclick="showRewardedAndCalculate()">
        <i class="fas fa-gem"></i> Detailed Analysis
      </button>
    </div>
  </div>

  <!-- Native Ad below -->
  <div class="ad-box" id="nativeAdCalculator">
    Advertisement
  </div>
  <div class="ad-note">Advertisement supports free access to this tool</div>

  <div id="resultContainer" class="result-container">
    <div class="result-card">
      <div class="result-header">
        <div class="result-title">Your Capital Estimate</div>
        <div style="color: var(--gray); font-size: 14px;">Generated: <span id="resultDate"></span></div>
      </div>
      
      <div class="result-amount" id="resultAmount">KES 0</div>
      
      <div class="result-details">
        <div class="result-item">
          <div class="result-label">Business Type</div>
          <div class="result-value" id="detailType">-</div>
        </div>
        <div class="result-item">
          <div class="result-label">Recommended Range</div>
          <div class="result-value" id="detailRange">-</div>
        </div>
        <div class="result-item">
          <div class="result-label">Nyota Fund Match</div>
          <div class="result-value" id="detailMatch">-</div>
        </div>
        <div class="result-item">
          <div class="result-label">Expected Payback</div>
          <div class="result-value" id="detailPayback">-</div>
        </div>
      </div>
    </div>

    <div class="recommendations">
      <h4><i class="fas fa-lightbulb"></i> Recommendations 
        <span id="detailLock" class="locked-feature">
          <i class="fas fa-lock"></i> Detailed analysis requires ad view
        </span>
      </h4>
      <div id="recommendationsList">
        <!-- Filled by JavaScript -->
      </div>
    </div>

    <div class="sharing-buttons">
      <button id="whatsappBtn" class="share-btn share-whatsapp share-btn-locked" onclick="requestShareAccess()">
        <i class="fab fa-whatsapp"></i> Share on WhatsApp
        <span class="lock-icon"><i class="fas fa-lock"></i></span>
      </button>
      <button id="printBtn" class="share-btn share-print share-btn-locked" onclick="requestPrintAccess()">
        <i class="fas fa-print"></i> Print Estimate
        <span class="lock-icon"><i class="fas fa-lock"></i></span>
      </button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top: 0; color: var(--primary);">
      <i class="fas fa-history"></i> Recent Estimates
    </h3>
    <div id="historyList">
      <div class="history-item">
        <span>Retail Shop</span>
        <span class="history-amount">KES 150,000</span>
      </div>
      <div class="history-item">
        <span>Agribusiness</span>
        <span class="history-amount">KES 280,000</span>
      </div>
    </div>
  </div>

  <div class="note" style="text-align: center; font-size: 13px; color: #666; margin-top: 20px;">
    <i class="fas fa-exclamation-circle"></i> This estimator provides guidance only. Actual Nyota Fund allocation depends on official assessment and availability.
  </div>
</div>

<!-- Modal for Detailed Analysis -->
<div id="rewardModal" class="modal">
  <div class="modal-content">
    <h3><i class="fas fa-gem"></i> Unlock Detailed Analysis</h3>
    <p>Watch a short advertisement to unlock:</p>
    <ul style="text-align: left; margin: 20px;">
      <li>Detailed breakdown of capital allocation</li>
      <li>Personalized recommendations</li>
      <li>Nyota Fund success probability</li>
      <li>Business planning template</li>
      <li><strong>Share & Print functionality</strong></li>
    </ul>
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="closeModal()">Maybe Later</button>
      <button class="btn btn-rewarded" onclick="proceedWithAd()">Watch Ad & Unlock</button>
    </div>
  </div>
</div>

<!-- Modal for Share/Print Access -->
<div id="accessModal" class="modal">
  <div class="modal-content">
    <h3><i class="fas fa-lock-open"></i> Unlock Sharing Features</h3>
    <p>To share or print your estimate, please watch a short advertisement.</p>
    <p>This helps us keep the tool free for everyone.</p>
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="closeAccessModal()">Cancel</button>
      <button class="btn btn-rewarded" onclick="unlockSharingFeatures()">Watch Ad & Unlock</button>
    </div>
  </div>
</div>

<footer>
  <p>¬© 2024 Nyota Fund Guide | This tool is for informational purposes only.</p>
  <p>Not affiliated with the Government of Kenya or Nyota Fund.</p>
</footer>

<script>
  // DOM Elements
  const amountRange = document.getElementById('amountRange');
  const amountValue = document.getElementById('amountValue');
  const amountInput = document.getElementById('amountInput');
  const resultContainer = document.getElementById('resultContainer');
  const resultAmount = document.getElementById('resultAmount');
  const resultDate = document.getElementById('resultDate');
  const detailType = document.getElementById('detailType');
  const detailRange = document.getElementById('detailRange');
  const detailMatch = document.getElementById('detailMatch');
  const detailPayback = document.getElementById('detailPayback');
  const recommendationsList = document.getElementById('recommendationsList');
  const historyList = document.getElementById('historyList');
  const rewardModal = document.getElementById('rewardModal');
  const accessModal = document.getElementById('accessModal');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const printBtn = document.getElementById('printBtn');
  const detailLock = document.getElementById('detailLock');

  // State variables
  let userHasWatchedAd = false;
  let currentEstimateData = null;

  // Business type data
  const businessData = {
    retail: { min: 50000, max: 300000, match: 70, payback: "12-18 months" },
    agribusiness: { min: 100000, max: 500000, match: 80, payback: "18-24 months" },
    service: { min: 30000, max: 200000, match: 65, payback: "10-15 months" },
    manufacturing: { min: 150000, max: 800000, match: 75, payback: "24-36 months" },
    food: { min: 80000, max: 350000, match: 70, payback: "12-20 months" },
    tech: { min: 50000, max: 250000, match: 85, payback: "8-14 months" },
    fashion: { min: 40000, max: 200000, match: 60, payback: "10-16 months" },
    transport: { min: 100000, max: 600000, match: 70, payback: "15-24 months" },
    other: { min: 50000, max: 300000, match: 65, payback: "12-20 months" }
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateAmountDisplay();
    loadHistory();
    
    // Set current date
    resultDate.textContent = new Date().toLocaleDateString('en-US', {
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    });

    // Check if user previously watched ad
    const adWatched = localStorage.getItem('nyotaAdWatched');
    if (adWatched === 'true') {
      userHasWatchedAd = true;
      unlockFeatures();
    }
  });

  // Range slider update
  amountRange.addEventListener('input', updateAmountDisplay);
  
  // Input field sync
  amountInput.addEventListener('input', function() {
    const value = parseInt(this.value) || 150000;
    amountRange.value = value;
    updateAmountDisplay();
  });

  function updateAmountDisplay() {
    const value = parseInt(amountRange.value);
    amountValue.textContent = value.toLocaleString();
    amountInput.value = value;
  }

  // Quick Estimate (no ad)
  function quickEstimate() {
    calculate(false);
  }

  // Show rewarded ad modal for detailed analysis
  function showRewardedAndCalculate() {
    rewardModal.style.display = 'flex';
  }

  function closeModal() {
    rewardModal.style.display = 'none';
  }

  function proceedWithAd() {
    closeModal();
    
    // Simulate ad view (replace with actual median integration)
    if (typeof median !== "undefined" && median.showRewarded) {
      median.showRewarded(function(success){
        if(success){
          userHasWatchedAd = true;
          localStorage.setItem('nyotaAdWatched', 'true');
          unlockFeatures();
          calculate(true); // User watched ad, show detailed result
        } else {
          alert("Please watch the ad to unlock detailed analysis.");
        }
      });
    } else {
      // Fallback for demo
      setTimeout(() => {
        userHasWatchedAd = true;
        localStorage.setItem('nyotaAdWatched', 'true');
        unlockFeatures();
        calculate(true);
      }, 500);
    }
  }

  // Main calculation function
  function calculate(isDetailed = false) {
    const businessType = document.getElementById('businessType').value;
    const location = document.getElementById('businessLocation').value;
    const stage = document.getElementById('businessStage').value;
    const amount = parseInt(amountInput.value) || parseInt(amountRange.value);
    const revenue = parseInt(document.getElementById('expectedRevenue').value) || 0;
    
    // Get allocations
    const allocations = Array.from(document.querySelectorAll('input[name="allocation"]:checked'))
      .map(cb => cb.value);
    
    // Basic validation
    if (amount < 10000) {
      alert('Minimum capital should be at least KES 10,000');
      return;
    }
    
    if (amount > 2000000) {
      alert('Maximum capital for Nyota Fund is typically KES 2,000,000');
      return;
    }
    
    // Get business data
    const data = businessData[businessType];
    
    // Calculate recommended range with location factor
    let locationFactor = 1.0;
    if (location === 'urban') locationFactor = 1.2;
    if (location === 'rural') locationFactor = 0.9;
    
    const recommendedMin = Math.round(data.min * locationFactor);
    const recommendedMax = Math.round(data.max * locationFactor);
    
    // Adjust match percentage based on stage
    let matchPercentage = data.match;
    if (stage === 'idea') matchPercentage -= 10;
    if (stage === 'expansion') matchPercentage += 5;
    
    const matchedAmount = Math.round(amount * (matchPercentage / 100));
    
    // Calculate payback period
    let payback = data.payback;
    if (revenue > 0) {
      const months = Math.ceil(amount / (revenue * 0.3)); // Assuming 30% profit margin
      payback = `${Math.max(6, months)}-${Math.max(8, months + 6)} months`;
    }
    
    // Update result display
    resultAmount.textContent = `KES ${amount.toLocaleString()}`;
    detailType.textContent = document.getElementById('businessType').options[document.getElementById('businessType').selectedIndex].text;
    detailRange.textContent = `KES ${recommendedMin.toLocaleString()} - ${recommendedMax.toLocaleString()}`;
    detailMatch.textContent = `${matchPercentage}% (KES ${matchedAmount.toLocaleString()})`;
    detailPayback.textContent = payback;
    
    // Store estimate data for sharing
    currentEstimateData = {
      businessType: document.getElementById('businessType').options[document.getElementById('businessType').selectedIndex].text,
      amount: amount,
      location: document.getElementById('businessLocation').options[document.getElementById('businessLocation').selectedIndex].text,
      stage: document.getElementById('businessStage').options[document.getElementById('businessStage').selectedIndex].text,
      match: matchPercentage,
      matchedAmount: matchedAmount,
      payback: payback,
      timestamp: new Date().toLocaleDateString()
    };
    
    // Generate recommendations
    let recommendations = '';
    
    if (amount < recommendedMin) {
      recommendations += `<li>Consider increasing capital to at least KES ${recommendedMin.toLocaleString()} for this business type</li>`;
    }
    
    if (amount > recommendedMax) {
      recommendations += `<li>Amount may be too high for Nyota Fund. Consider splitting into phases</li>`;
    }
    
    if (stage === 'idea') {
      recommendations += `<li>Develop a detailed business plan before applying</li>`;
      recommendations += `<li>Consider attending entrepreneurship training first</li>`;
    }
    
    if (allocations.length === 0) {
      recommendations += `<li>Specify how you'll use the funds for a stronger application</li>`;
    } else {
      recommendations += `<li>Good allocation plan: ${allocations.join(', ')}</li>`;
    }
    
    if (isDetailed && userHasWatchedAd) {
      // Detailed recommendations (after watching ad)
      recommendations += `<li>Nyota Fund success probability: ${calculateSuccessProbability(amount, businessType, stage)}%</li>`;
      recommendations += `<li>Recommended first step: Register business with Registrar of Companies</li>`;
      recommendations += `<li>Documentation: Prepare 3 months of bank statements (if existing business)</li>`;
      recommendations += `<li>Consider applying in ${getBestApplicationMonth()} for faster processing</li>`;
      detailLock.style.display = 'none';
    } else {
      recommendations += `<li><em>Watch an ad to unlock: Success probability, step-by-step plan, and sharing features</em></li>`;
      detailLock.style.display = 'inline-block';
    }
    
    recommendationsList.innerHTML = `<ul>${recommendations}</ul>`;
    
    // Show result with animation
    resultContainer.style.display = 'block';
    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Save to history
    saveToHistory(businessType, amount);
  }

  // Unlock sharing features
  function unlockFeatures() {
    whatsappBtn.classList.remove('share-btn-locked');
    printBtn.classList.remove('share-btn-locked');
    whatsappBtn.querySelector('.lock-icon').style.display = 'none';
    printBtn.querySelector('.lock-icon').style.display = 'none';
    
    whatsappBtn.onclick = shareOnWhatsApp;
    printBtn.onclick = printEstimate;
    
    // Update button text
    whatsappBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Share on WhatsApp';
    printBtn.innerHTML = '<i class="fas fa-print"></i> Print Estimate';
  }

  // Request access to sharing features
  function requestShareAccess() {
    if (!userHasWatchedAd) {
      accessModal.style.display = 'flex';
    } else {
      shareOnWhatsApp();
    }
  }

  function requestPrintAccess() {
    if (!userHasWatchedAd) {
      accessModal.style.display = 'flex';
    } else {
      printEstimate();
    }
  }

  function closeAccessModal() {
    accessModal.style.display = 'none';
  }

  function unlockSharingFeatures() {
    closeAccessModal();
    
    // Simulate ad view for sharing features
    if (typeof median !== "undefined" && median.showRewarded) {
      median.showRewarded(function(success){
        if(success){
          userHasWatchedAd = true;
          localStorage.setItem('nyotaAdWatched', 'true');
          unlockFeatures();
          alert('Sharing features unlocked! You can now share and print your estimates.');
        } else {
          alert("Please watch the ad to unlock sharing features.");
        }
      });
    } else {
      // Fallback for demo
      userHasWatchedAd = true;
      localStorage.setItem('nyotaAdWatched', 'true');
      unlockFeatures();
      alert('Sharing features unlocked! You can now share and print your estimates.');
    }
  }

  // Helper functions
  function calculateSuccessProbability(amount, type, stage) {
    let probability = 70;
    
    if (amount <= businessData[type].max) probability += 15;
    if (amount > businessData[type].max * 1.5) probability -= 20;
    if (stage === 'growth' || stage === 'expansion') probability += 10;
    if (stage === 'idea') probability -= 5;
    
    return Math.min(95, Math.max(30, probability));
  }

  function getBestApplicationMonth() {
    const months = ['January', 'March', 'June', 'September'];
    return months[Math.floor(Math.random() * months.length)];
  }

  function saveToHistory(type, amount) {
    const typeName = document.getElementById('businessType').options[document.getElementById('businessType').selectedIndex].text;
    
    // Create history item
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.innerHTML = `
      <span>${typeName}</span>
      <span class="history-amount">KES ${amount.toLocaleString()}</span>
    `;
    
    // Add to top of history
    historyList.insertBefore(historyItem, historyList.firstChild);
    
    // Limit to 5 items
    if (historyList.children.length > 5) {
      historyList.removeChild(historyList.lastChild);
    }
    
    // Save to localStorage
    const history = JSON.parse(localStorage.getItem('capitalHistory') || '[]');
    history.unshift({
      type: typeName,
      amount: amount,
      date: new Date().toISOString()
    });
    
    if (history.length > 5) history.length = 5;
    localStorage.setItem('capitalHistory', JSON.stringify(history));
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem('capitalHistory') || '[]');
    
    if (history.length > 0) {
      historyList.innerHTML = '';
      history.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <span>${item.type}</span>
          <span class="history-amount">KES ${parseInt(item.amount).toLocaleString()}</span>
        `;
        historyList.appendChild(historyItem);
      });
    }
  }

  function saveForLater() {
    const businessType = document.getElementById('businessType').value;
    const amount = parseInt(amountInput.value) || parseInt(amountRange.value);
    
    const saveData = {
      businessType: businessType,
      amount: amount,
      location: document.getElementById('businessLocation').value,
      stage: document.getElementById('businessStage').value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('savedEstimate', JSON.stringify(saveData));
    
    alert('Estimate saved! You can return to it later.');
  }

  function shareOnWhatsApp() {
    if (!userHasWatchedAd) {
      requestShareAccess();
      return;
    }
    
    if (!currentEstimateData) {
      alert('Please generate an estimate first.');
      return;
    }
    
    const message = `üìä My Nyota Fund Capital Estimate:\n\n` +
                   `üè¢ Business: ${currentEstimateData.businessType}\n` +
                   `üí∞ Capital Needed: KES ${currentEstimateData.amount.toLocaleString()}\n` +
                   `üìç Location: ${currentEstimateData.location}\n` +
                   `üìà Stage: ${currentEstimateData.stage}\n` +
                   `üéØ Nyota Fund Match: ${currentEstimateData.match}%\n` +
                   `‚è±Ô∏è Expected Payback: ${currentEstimateData.payback}\n\n` +
                   `Generated via Nyota Fund Guide\n` +
                   `Date: ${currentEstimateData.timestamp}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  }

  function printEstimate() {
    if (!userHasWatchedAd) {
      requestPrintAccess();
      return;
    }
    
    if (!currentEstimateData) {
      alert('Please generate an estimate first.');
      return;
    }
    
    const printContent = resultContainer.innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
      <div style="padding: 30px; max-width: 800px; margin: 0 auto;">
        <h1 style="color: #0b7a43; border-bottom: 2px solid #0b7a43; padding-bottom: 10px;">
          <i class="fas fa-calculator"></i> Nyota Fund Capital Estimate
        </h1>
        <div style="color: #666; margin-bottom: 20px;">
          Generated on ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
        </div>
        ${printContent}
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
          <p>This estimate is for planning purposes only. Not an official Nyota Fund document.</p>
          <p>¬© 2024 Nyota Fund Guide | Generated at ${new Date().toLocaleTimeString()}</p>
        </div>
      </div>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
  }
</script>

</body>
</html>
